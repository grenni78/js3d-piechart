var PieChart=new Class({Implements:Chain,canvasWidth:400,canvasHeight:400,center:new JS3D_Point(0,0,0),radius:1,height:1,distance:200,resolution:80,alpha:30,beta:0,gamma:0,transX:0,transY:0,transZ:0,transformMatrix:Class.empty,rot_Matrix:Class.empty,trans_Matrix:Class.empty,sum_values:0,geometry:Class.empty,geometry_centers:Class.empty,localTransformation:new Array(),slices:new Array(),labels:new Array(),labelAnchors:new Array(),legend:{shadow:{offset:{x:1,y:2},opacity:0.3,blur:5,},position:"tr",width:0.33,font:{size:9,family:"Arial, sans-serif",weight:"normal",style:"normal"},textColor:"rgb(50,50,150)",lineHeight:1.5,fillStyle:"rgba(254,248,170,.8)"},initialize:function(d,b,a,e,c){this.canvas=d;this.radius=b;this.resolution=2*Math.PI*b/15;this.height=a;this.setCanvasSize(e,c);this.startAnimation()},setDistance:function(a){this.distance=a},setCanvasSize:function(a,b){this.canvasWidth=a;this.canvasHeight=b},setPieCenter:function(){this.center.z=Math.sqrt(Math.pow((this.height/2),2)+Math.pow(this.radius,2));this.center.x=this.canvasWidth/2;this.center.y=this.canvasHeight/2-this.height/2},startAnimation:function(){var a=this;this.running=true;this.update();(function(){this.draw();this.update()}).periodical(80,a)},rotate:function(c,b,a){this.alpha=(c>=0&&c<=360)?c:this.alpha;this.beta=(b>=0&&b<=360)?b:this.beta;this.gamma=(a>=0&&a<=360)?a:this.gamma},update:function(){this.setPieCenter();this.rotMatrix();this.transMatrix();this.persMatrix();this.transformMatrix();this.updateGeometry()},exposeSlice:function(b,e,d){if(e==0&&d==0){this.localTransformation.splice(b,1);return}var c=(this.slices[b].arcEnd-this.slices[b].arcStart)/2+this.slices[b].arcStart;c=c*Math.PI/180;var a=Math.cos(c)*e;var f=Math.sin(c)*e;var g=-Math.sin(d*Math.PI/180)*e;this.localTransformation[b]=[[1,0,0,f],[0,1,0,g],[0,0,1,a],[0,0,0,1]]},addSlice:function(d,b,c){if(this.sum_values+d>1){return}var a=this.resolution*d;var e=new PieChart_Slice(this.sum_values*360,d,this.radius,this.height,a,b,false);this.sum_values+=d;this.slices.push(e);this.labels.push(c+": "+Math.round(d*1000)/10+"%")},clearSlices:function(){this.slices=new Array()},rotMatrix:function(){var g=function(a){return Math.cos(a)};var f=function(a){return Math.sin(a)};var e=this.alpha*Math.PI/180;var d=this.beta*Math.PI/180;var h=this.gamma*Math.PI/180;this.rot_Matrix=[[g(h)*g(d)-f(h)*f(e)*f(d),f(h)*g(e),g(h)*f(d)+f(h)*f(e)*g(d),0],[f(h)*g(d)+g(h)*f(e)*f(d),g(h)*g(e),f(h)*f(d)-g(h)*f(e)*g(d),0],[-f(d)*g(e),f(e),g(e)*g(d),0],[0,0,0,1]]},transMatrix:function(){this.trans_Matrix=[[1,0,0,this.transX+this.center.x],[0,1,0,this.transY+this.center.y],[0,0,1,this.transZ+this.center.z],[0,0,0,1]]},persMatrix:function(){this.pers_Matrix=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,1/this.distance,0]]},transformMatrix:function(){this.matrix=MatrixHelper.multiply(this.trans_Matrix,this.rot_Matrix);this.matrix=MatrixHelper.multiply(this.pers_Matrix,this.matrix)},transform:function(a,b){var d;if($defined(a.x)){d=[[a.x],[a.y],[a.z],[1]]}else{d=[[a[0]],[a[1]],[a[2]],[1]]}var c=d;if(arguments.length>1){c=MatrixHelper.multiply(b,c)}c=MatrixHelper.multiply(this.matrix,c);return{x:Math.ceil(c[0][0]),y:Math.ceil(c[1][0]),z:Math.ceil(c[2][0])}},updateGeometry:function(){this.geometry=new Array();for(var c=0;c<this.slices.length;c++){var l=this.slices[c];for(var b=0;b<l.faces.length-1;b++){var d=new Array();for(var a=0;a<l.faces[b].points.length;a++){if($defined(this.localTransformation[c])){var h=this.transform(l.faces[b].points[a],this.localTransformation[c])}else{var h=this.transform(l.faces[b].points[a])}d.push(new JS3D_Point(h.x,h.y,h.z))}var g=new JS3D_Face(d,l.faces[b].fillStyle);this.geometry.push(g)}if($defined(this.localTransformation[c])){this.labelAnchors[c]=this.transform(l.anchorPoint,this.localTransformation[c]);this.slices[c].origin=this.transform(l.origin,this.localTransformation[c])}this.labelAnchors[c]=this.transform(l.anchorPoint);this.slices[c].origin=this.transform(l.origin)}this.geometry_centers=new Array(this.geometry.length);for(var c=0;c<this.geometry.length;c++){this.geometry_centers[c]={l:this.geometry[c].lowestZ,h:this.geometry[c].highestZ,z:this.geometry[c].center.z,idx:c}}var e=this;this.geometry_centers=this.geometry_centers.sort((function(i,f){if(i.z<f.z){return 1}else{if(i.z>f.z){return -1}}var k=this.geometry[i.idx].distanceToRoot;var j=this.geometry[f.idx].distanceToRoot;if(k>j){return -1}else{return 1}return 0}).bind(e))},drawShadow:function(n,j,i,l,d,a,m,k,c,f){var e=f-c*0.05;for(var g=c;g>0;g--){n.roundRect(j-g+m,i-g+k,l+2*g,d+2*g,a+g,true,false,"rgba(0,0,0,"+e+")")}},drawLegend:function(c){var b=this.legend.width*this.canvasWidth;var e=this.slices.length*this.legend.font.size*this.legend.lineHeight+this.legend.font.size;var a,f;if(this.legend.position[0]="t"){f=this.legend.shadow.blur-this.legend.shadow.offset.y}else{if(this.legend.position[0]="b"){f=this.canvasHeight-e-this.legend.shadow.blur-this.legend.shadow.offset.y}}if(this.legend.position[1]="r"){a=this.canvasWidth-b-this.legend.shadow.blur-this.legend.shadow.offset.x}else{if(this.legend.position[1]="r"){a=this.legend.shadow.blur-this.legend.shadow.offset.x}}if(!($defined(a)&&$defined(f))){return}this.drawShadow(c,a,f,b,e,5,this.legend.shadow.offset.x,this.legend.shadow.offset.y,this.legend.shadow.blur,this.legend.shadow.opacity);c.roundRect(a,f,b,e,5,true,false,this.legend.fillStyle);c.font=this.legend.font.size+"px "+this.legend.font.family;c.fillStyle=this.legend.textColor;for(var d=0;d<this.slices.length;d++){c.fillText(this.labels[d],a+this.legend.font.size,Math.round(f+this.legend.font.size*this.legend.lineHeight*(d+1)))}},draw:function(){var b=this.canvas.getContext("2d");b.save();b.clearRect(0,0,this.canvas.width,this.canvas.height);var a=b;for(var d=0;d<this.geometry_centers.length;d++){var e=this.geometry[this.geometry_centers[d].idx];a.strokeStyle=e.fillStyle;a.fillStyle=e.fillStyle;var f=e.points[0];a.beginPath();a.moveTo(f.x,f.y);for(var c=1;c<e.points.length;c++){f=e.points[c];a.lineTo(f.x,f.y)}a.fill();if(this.showNormals){a.beginPath();a.moveTo(e.center.x,e.center.y);a.lineTo(e.center.x+e.normalVector0[0]*50,e.center.y+e.normalVector0[1]*50);a.strokeStyle="black";a.stroke();a.beginPath();a.arc(e.center.x+e.normalVector0[0]*50,e.center.y+e.normalVector0[1]*50,5,0,Math.PI*2,false);a.fillStyle="yellow";a.fill();a.stroke()}}this.drawLegend(b);b.restore()}});