var PieChart=new Class({Implements:Chain,canvasWidth:400,canvasHeight:400,center:new JS3D_Point(0,0,0),radius:1,height:1,distance:200,resolution:80,alpha:30,beta:0,gamma:0,transX:0,transY:0,transZ:0,transformMatrix:Class.empty,rot_Matrix:Class.empty,trans_Matrix:Class.empty,sum_values:0,geometry:Class.empty,geometry_centers:Class.empty,localTransformation:new Array,slices:new Array,labels:new Array,labelAnchors:new Array,legend:{shadow:{offset:{x:1,y:2},opacity:.3,blur:5},position:"tr",width:.34,font:{size:9,family:"Arial, sans-serif",weight:"normal",style:"normal"},textColor:"rgb(50,50,150)",lineHeight:1.5,fillStyle:"rgba(254,248,170,.8)"},initialize:function(t,e,i,s,a){this.canvas=t,this.radius=e,this.resolution=2*Math.PI*e/15,this.height=i,this.setCanvasSize(s,a),this.startAnimation()},setDistance:function(t){this.distance=t},setCanvasSize:function(t,e){this.canvasWidth=t,this.canvasHeight=e},setPieCenter:function(){this.center.z=Math.sqrt(Math.pow(this.height/2,2)+Math.pow(this.radius,2)),this.center.x=this.canvasWidth/2,this.center.y=this.canvasHeight/2-this.height/2},startAnimation:function(){var t=this;this.running=!0,this.update(),function(){this.draw(),this.update()}.periodical(80,t)},rotate:function(t,e,i){this.alpha=t>=0&&t<=360?t:this.alpha,this.beta=e>=0&&e<=360?e:this.beta,this.gamma=i>=0&&i<=360?i:this.gamma},update:function(){this.setPieCenter(),this.rotMatrix(),this.transMatrix(),this.persMatrix(),this.transformMatrix(),this.updateGeometry()},exposeSlice:function(t,e,i){if(0==e&&0==i)return void this.localTransformation.splice(t,1);var s=(this.slices[t].arcEnd-this.slices[t].arcStart)/2+this.slices[t].arcStart;s=s*Math.PI/180;var a=Math.cos(s)*e,n=Math.sin(s)*e,r=-Math.sin(i*Math.PI/180)*e;this.localTransformation[t]=[[1,0,0,n],[0,1,0,r],[0,0,1,a],[0,0,0,1]]},addSlice:function(t,e,i){if(!(this.sum_values+t>1)){var s=this.resolution*t,a=new PieChart_Slice(360*this.sum_values,t,this.radius,this.height,s,e,!1);this.sum_values+=t,this.slices.push(a),this.labels.push(i+": "+Math.round(1e3*t)/10+"%")}},clearSlices:function(){this.slices=new Array},rotMatrix:function(){var t=function(t){return Math.cos(t)},e=function(t){return Math.sin(t)},i=this.alpha*Math.PI/180,s=this.beta*Math.PI/180,a=this.gamma*Math.PI/180;this.rot_Matrix=[[t(a)*t(s)-e(a)*e(i)*e(s),e(a)*t(i),t(a)*e(s)+e(a)*e(i)*t(s),0],[e(a)*t(s)+t(a)*e(i)*e(s),t(a)*t(i),e(a)*e(s)-t(a)*e(i)*t(s),0],[-e(s)*t(i),e(i),t(i)*t(s),0],[0,0,0,1]]},transMatrix:function(){this.trans_Matrix=[[1,0,0,this.transX+this.center.x],[0,1,0,this.transY+this.center.y],[0,0,1,this.transZ+this.center.z],[0,0,0,1]]},persMatrix:function(){this.pers_Matrix=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,1/this.distance,0]]},transformMatrix:function(){this.matrix=MatrixHelper.multiply(this.trans_Matrix,this.rot_Matrix),this.matrix=MatrixHelper.multiply(this.pers_Matrix,this.matrix)},transform:function(t,e){var i;i=$defined(t.x)?[[t.x],[t.y],[t.z],[1]]:[[t[0]],[t[1]],[t[2]],[1]];var s=i;return arguments.length>1&&(s=MatrixHelper.multiply(e,s)),s=MatrixHelper.multiply(this.matrix,s),{x:Math.ceil(s[0][0]),y:Math.ceil(s[1][0]),z:Math.ceil(s[2][0])}},updateGeometry:function(){this.geometry=new Array;for(var t=0;t<this.slices.length;t++){for(var e=this.slices[t],i=0;i<e.faces.length-1;i++){for(var s=new Array,a=0;a<e.faces[i].points.length;a++){if($defined(this.localTransformation[t]))var n=this.transform(e.faces[i].points[a],this.localTransformation[t]);else var n=this.transform(e.faces[i].points[a]);s.push(new JS3D_Point(n.x,n.y,n.z))}var r=new JS3D_Face(s,e.faces[i].fillStyle);this.geometry.push(r)}$defined(this.localTransformation[t])&&(this.labelAnchors[t]=this.transform(e.anchorPoint,this.localTransformation[t]),this.slices[t].origin=this.transform(e.origin,this.localTransformation[t])),this.labelAnchors[t]=this.transform(e.anchorPoint),this.slices[t].origin=this.transform(e.origin)}this.geometry_centers=new Array(this.geometry.length);for(var t=0;t<this.geometry.length;t++)this.geometry_centers[t]={l:this.geometry[t].lowestZ,h:this.geometry[t].highestZ,z:this.geometry[t].center.z,idx:t};var h=this;this.geometry_centers=this.geometry_centers.sort(function(t,e){if(t.z<e.z)return 1;if(t.z>e.z)return-1;var i=this.geometry[t.idx].distanceToRoot,s=this.geometry[e.idx].distanceToRoot;return i>s?-1:1}.bind(h))},drawShadow:function(t,e,i,s,a,n,r,h,o,l){for(var c=l-.05*o,f=o;f>0;f--)t.roundRect(e-f+r,i-f+h,s+2*f,a+2*f,n+f,!0,!1,"rgba(0,0,0,"+c+")")},drawLegend:function(t){var e,i,s=this.legend.width*this.canvasWidth,a=this.slices.length*this.legend.font.size*this.legend.lineHeight+this.legend.font.size;if((this.legend.position[0]="t")?i=this.legend.shadow.blur-this.legend.shadow.offset.y:(this.legend.position[0]="b")&&(i=this.canvasHeight-a-this.legend.shadow.blur-this.legend.shadow.offset.y),(this.legend.position[1]="r")?e=this.canvasWidth-s-this.legend.shadow.blur-this.legend.shadow.offset.x:(this.legend.position[1]="r")&&(e=this.legend.shadow.blur-this.legend.shadow.offset.x),$defined(e)&&$defined(i)){this.drawShadow(t,e,i,s,a,5,this.legend.shadow.offset.x,this.legend.shadow.offset.y,this.legend.shadow.blur,this.legend.shadow.opacity),t.roundRect(e,i,s,a,5,!0,!1,this.legend.fillStyle),t.font=this.legend.font.size+"px "+this.legend.font.family,t.fillStyle=this.legend.textColor;for(var n=i,r=0;r<this.slices.length;r++)n+=Math.round(this.legend.font.size*this.legend.lineHeight),t.roundRect(e+4,n-this.legend.font.size/(.75*this.legend.lineHeight),this.legend.font.size,this.legend.font.size,3,!0,!0,this.slices[r].fillStyle,"rgba(220,220,220,.8)",2),t.fillText(this.labels[r],e+1.5*this.legend.font.size,n)}},draw:function(){var t=this.canvas.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height);for(var e=t,i=0;i<this.geometry_centers.length;i++){var s=this.geometry[this.geometry_centers[i].idx];e.strokeStyle=s.fillStyle,e.fillStyle=s.fillStyle;var a=s.points[0];e.beginPath(),e.moveTo(a.x,a.y);for(var n=1;n<s.points.length;n++)a=s.points[n],e.lineTo(a.x,a.y);e.fill(),this.showNormals&&(e.beginPath(),e.moveTo(s.center.x,s.center.y),e.lineTo(s.center.x+50*s.normalVector0[0],s.center.y+50*s.normalVector0[1]),e.strokeStyle="black",e.stroke(),e.beginPath(),e.arc(s.center.x+50*s.normalVector0[0],s.center.y+50*s.normalVector0[1],5,0,2*Math.PI,!1),e.fillStyle="yellow",e.fill(),e.stroke())}this.drawLegend(t),t.restore()}});