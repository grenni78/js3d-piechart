/**
 * @copyright   2011 - Holger Genth (http://www.grennis-welt.de)
 * @version     0.2a (10/2011)
 **/
var MatrixHelper=new Class();MatrixHelper.multiply=function(r,q){if($type(r)=="array"&&$type(q)=="array"){var e=r.length;var d=r[0].length;var b=q.length;var a=q[0].length;if(d!=b){return -1}var p=new Array(e);for(var h=0;h<e;h++){p[h]=new Array(a);for(var g=0;g<a;g++){p[h][g]=0;for(var f=0;f<d;f++){p[h][g]+=r[h][f]*q[f][g]}}}return p}};MatrixHelper.add=function(b,a){};var JS3D_RGBA=new Class({r:0,g:0,b:0,a:1,initialize:function(f,e,c,d){this.setRed(f);this.setGreen(e);this.setBlue(c);this.setAlpha(d)},checkColor:function(a){if(a>254){a=254}else{if(a<0){a=0}}return Math.round(a)},checkAlpha:function(a){if(a>1){a=1}else{if(a<0){a=0}}return a},setRed:function(a){this.r=this.checkColor(a)},setGreen:function(a){this.g=this.checkColor(a)},setBlue:function(a){this.b=this.checkColor(a)},setAlpha:function(a){this.a=this.checkAlpha(a)},getRed:function(){return this.r},getGreen:function(){return this.g},getBlue:function(){return this.b},getAlpha:function(){return this.a},getCSSRGB:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},getCSSRGBA:function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")"},getBrighterColor:function(c){if(c>1){c/=100}else{if(c<0){c=0}}var e=this.r*(1+c);var d=this.g*(1+c);var a=this.b*(1+c);return new JS3D_RGBA(e,d,a,this.a)},getDarkerColor:function(c){if(c>1){c/=100}else{if(c<0){c=0}}var e=this.r*(1-c);var d=this.g*(1-c);var a=this.b*(1-c);return new JS3D_RGBA(e,d,a,this.a)}});var JS2D_Point=new Class({initialize:function(a,b){this.x=a;this.y=b},add:function(a){this.x+=a.x;this.y+=a.y},divScalar:function(a){this.x/=a;this.y/=a},getX:function(){return this.x},getY:function(){return this.y}});var JS3D_Point=new Class({initialize:function(a,c,b){this.x=a;this.y=c;this.z=b},add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z},divScalar:function(a){this.x/=a;this.y/=a;this.z/=a},getX:function(){return this.x},getY:function(){return this.y},getZ:function(){return this.z}});var JS3D_Face=new Class({points:-1,center:Class.empty,lowestZ:999,highestZ:0,fillStyle:"rgba(128,128,128,0.2)",strokeStyle:"rgba(0,0,0,0)",initialize:function(b,a){if(arguments.length>1){this.setFillStyle(a)}this.setPoints(b)},setPoints:function(a){if($type(a)=="array"){if($defined(a[0].x)){this.points=a;this.updateCenter()}}},invertNormalVector:function(){this.normalVector[0]=-this.normalVector[0];this.normalVector[1]=-this.normalVector[1];this.normalVector[2]=-this.normalVector[2];this._calculateNormalVector0()},_calculateNormalVector0:function(){var b=this.normalVector;var a=Math.sqrt(Math.pow(b[0],2)+Math.pow(b[1],2)+Math.pow(b[2],2));this.normalVector0=[b[0]/a,b[1]/a,b[2]/a]},_calculateNormalVector:function(){if(this.points.length<3){return}if($defined(this.normalVector)){return}var a=0;var f=1;var c=2;var e=[this.points[0].x-this.points[2].x,this.points[0].y-this.points[2].y,this.points[0].z-this.points[2].z];var b=[this.points[1].x-this.points[2].x,this.points[1].y-this.points[2].y,this.points[1].z-this.points[2].z];var d=[e[f]*b[c]-e[c]*b[f],e[c]*b[a]-e[a]*b[c],e[a]*b[f]-e[f]*b[a]];this.normalVector=d;this._calculateNormalVector0();this._calculateDistanceToRoot()},_calculateDistanceToRoot:function(){this.distanceToRoot=this.points[0].x*this.normalVector0[0]+this.points[0].y*this.normalVector0[1]+this.points[0].z*this.normalVector0[2]},updateCenter:function(){this.center=new JS3D_Point(this.points[0].x,this.points[0].y,this.points[0].z);var a=0;for(a=0;a<this.points.length;a++){this.center.add(this.points[a]);if(this.highestZ<this.points[a].z){this.highestZ=this.points[a].z}if(this.lowestZ>this.points[a].z){this.lowestZ=this.points[a].z}}this.center.divScalar(a+1);this._calculateNormalVector()},addPoints:function(a){if($type(a)=="array"){if($defined(a[0].x)){this.points=this.points.append(a);this.updateCenter()}}},setFillStyle:function(a){this.fillStyle=a},setStrokeStyle:function(a){this.strokeStyle=a},getNormalVector:function(){return this.normalVector},getDistanceFromPoint:function(a,e,c){if(this.points.length<3){return}if(!$defined(this.normalVector)){return}var b=a*this.normalVector0[0]+e*this.normalVector0[0]+c*this.normalVector0[2]-this.distanceToRoot;return b}});var PieChart_Slice=new Class({radius:1,height:1,value:1,arcStart:0,arcEnd:0,arcStep:0,steps:1,fillRGBA:Class.empty,fillStyle:"red",strokeRGBA:Class.empty,strokeStyle:"black",stroked:false,faces:new Array(),anchorPoint:Class.empty,origin:{x:0,y:0,z:0},initialize:function(h,e,b,a,c,g,d,f){if(e>1){return}this.height=a;this.value=e;this.radius=b;this.fillRGBA=g;this.fillStyle=g.getCSSRGBA();this.stroked=d;if(arguments.length>7){this.strokeRGBA=f;this.strokeStyle=f.getCSSRGBA()}this.arcStart=h;this.arcEnd=360*e+h;if(this.arcEnd>360){this.arcEnd=360}this.steps=c;this.arcStep=(this.arcEnd-this.arcStart)/c;this.generateFaces()},generateFaces:function(){var c=this.arcStart*Math.PI/180;var k=this.arcEnd*Math.PI/180;var e=this.arcStep*Math.PI/180;this.direction=(k-c)/2+c;this.origin.x=Math.sin(this.direction)*0.66;this.origin.z=Math.cos(this.direction)*0.66;this.origin.y=0;var d=this.fillRGBA.getBrighterColor(0.5);var g=this.fillRGBA.getDarkerColor(0.5);var h=new Array(6);for(var f=0;f<h.length;f++){h[f]={x:0,y:0,z:0}}var m=new Array();var b=this.arcStart;var l=b*Math.PI/180;h[0].x=0;h[0].y=-this.height/2;h[0].z=0;h[2].x=this.radius*Math.sin(c);h[2].y=-this.height/2;h[2].z=this.radius*Math.cos(c);h[3].x=this.radius*Math.sin(c);h[3].y=this.height/2;h[3].z=this.radius*Math.cos(c);h[5].x=0;h[5].y=this.height/2;h[5].z=0;this.faces.push(new JS3D_Face([new JS3D_Point(h[0].x,h[0].y,h[0].z),new JS3D_Point(h[2].x,h[2].y,h[2].z),new JS3D_Point(h[3].x,h[3].y,h[3].z),new JS3D_Point(h[5].x,h[5].y,h[5].z)],d.getCSSRGBA()));var j=new JS3D_Face([new JS3D_Point(h[0].x,h[0].y,h[0].z),new JS3D_Point(h[2].x,h[2].y,h[2].z)],d.getCSSRGBA());var a=new JS3D_Face([new JS3D_Point(h[5].x,h[5].y,h[5].z),new JS3D_Point(h[3].x,h[3].y,h[3].z)],d.getCSSRGBA());for(var f=1;f<this.steps;f++){b+=this.arcStep;l=b*Math.PI/180;h[1]={x:h[2].x,y:h[2].y,z:h[2].z};h[4]={x:h[3].x,y:h[3].y,z:h[3].z};h[2].x=this.radius*Math.sin(l);h[2].y=-this.height/2;h[2].z=this.radius*Math.cos(l);h[3].x=this.radius*Math.sin(l);h[3].y=this.height/2;h[3].z=this.radius*Math.cos(l);j.addPoints([new JS3D_Point(h[2].x,h[2].y,h[2].z)]);a.addPoints([new JS3D_Point(h[3].x,h[3].y,h[3].z)]);this.faces.push(new JS3D_Face([new JS3D_Point(h[1].x,h[1].y,h[1].z),new JS3D_Point(h[2].x,h[2].y,h[2].z),new JS3D_Point(h[3].x,h[3].y,h[3].z),new JS3D_Point(h[4].x,h[4].y,h[4].z)],this.fillRGBA.getCSSRGBA()))}this.faces.push(j);this.faces.push(a);this.anchorPoint=j.center;this.faces.push(new JS3D_Face([new JS3D_Point(h[0].x,h[0].y,h[0].z),new JS3D_Point(h[2].x,h[2].y,h[2].z),new JS3D_Point(h[3].x,h[3].y,h[3].z),new JS3D_Point(h[5].x,h[5].y,h[5].z)],d.getCSSRGBA()))}});var PieChart=new Class({Implements:Chain,canvasWidth:400,canvasHeight:400,center:new JS3D_Point(0,0,0),radius:1,height:1,distance:200,resolution:80,alpha:30,beta:0,gamma:0,transX:0,transY:0,transZ:0,transformMatrix:Class.empty,rot_Matrix:Class.empty,trans_Matrix:Class.empty,sum_values:0,geometry:Class.empty,geometry_centers:Class.empty,localTransformation:new Array(),slices:new Array(),labels:new Array(),labelAnchors:new Array(),legend:{shadow:{offset:{x:1,y:2},opacity:0.3,blur:5,},position:"tr",width:0.34,font:{size:9,family:"Arial, sans-serif",weight:"normal",style:"normal"},textColor:"rgb(50,50,150)",lineHeight:1.5,fillStyle:"rgba(254,248,170,.8)"},initialize:function(d,b,a,e,c){this.canvas=d;this.radius=b;this.resolution=2*Math.PI*b/15;this.height=a;this.setCanvasSize(e,c);this.startAnimation()},setDistance:function(a){this.distance=a},setCanvasSize:function(a,b){this.canvasWidth=a;this.canvasHeight=b},setPieCenter:function(){this.center.z=Math.sqrt(Math.pow((this.height/2),2)+Math.pow(this.radius,2));this.center.x=this.canvasWidth/2;this.center.y=this.canvasHeight/2-this.height/2},startAnimation:function(){var a=this;this.running=true;this.update();(function(){this.draw();this.update()}).periodical(80,a)},rotate:function(c,b,a){this.alpha=(c>=0&&c<=360)?c:this.alpha;this.beta=(b>=0&&b<=360)?b:this.beta;this.gamma=(a>=0&&a<=360)?a:this.gamma},update:function(){this.setPieCenter();this.rotMatrix();this.transMatrix();this.persMatrix();this.transformMatrix();this.updateGeometry()},exposeSlice:function(b,e,d){if(e==0&&d==0){this.localTransformation.splice(b,1);return}var c=(this.slices[b].arcEnd-this.slices[b].arcStart)/2+this.slices[b].arcStart;c=c*Math.PI/180;var a=Math.cos(c)*e;var f=Math.sin(c)*e;var g=-Math.sin(d*Math.PI/180)*e;this.localTransformation[b]=[[1,0,0,f],[0,1,0,g],[0,0,1,a],[0,0,0,1]]},addSlice:function(d,b,c){if(this.sum_values+d>1){return}var a=this.resolution*d;var e=new PieChart_Slice(this.sum_values*360,d,this.radius,this.height,a,b,false);this.sum_values+=d;this.slices.push(e);this.labels.push(c+": "+Math.round(d*1000)/10+"%")},clearSlices:function(){this.slices=new Array()},rotMatrix:function(){var g=function(a){return Math.cos(a)};var f=function(a){return Math.sin(a)};var e=this.alpha*Math.PI/180;var d=this.beta*Math.PI/180;var h=this.gamma*Math.PI/180;this.rot_Matrix=[[g(h)*g(d)-f(h)*f(e)*f(d),f(h)*g(e),g(h)*f(d)+f(h)*f(e)*g(d),0],[f(h)*g(d)+g(h)*f(e)*f(d),g(h)*g(e),f(h)*f(d)-g(h)*f(e)*g(d),0],[-f(d)*g(e),f(e),g(e)*g(d),0],[0,0,0,1]]},transMatrix:function(){this.trans_Matrix=[[1,0,0,this.transX+this.center.x],[0,1,0,this.transY+this.center.y],[0,0,1,this.transZ+this.center.z],[0,0,0,1]]},persMatrix:function(){this.pers_Matrix=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,1/this.distance,0]]},transformMatrix:function(){this.matrix=MatrixHelper.multiply(this.trans_Matrix,this.rot_Matrix);this.matrix=MatrixHelper.multiply(this.pers_Matrix,this.matrix)},transform:function(a,b){var d;if($defined(a.x)){d=[[a.x],[a.y],[a.z],[1]]}else{d=[[a[0]],[a[1]],[a[2]],[1]]}var c=d;if(arguments.length>1){c=MatrixHelper.multiply(b,c)}c=MatrixHelper.multiply(this.matrix,c);return{x:Math.ceil(c[0][0]),y:Math.ceil(c[1][0]),z:Math.ceil(c[2][0])}},updateGeometry:function(){this.geometry=new Array();for(var c=0;c<this.slices.length;c++){var l=this.slices[c];for(var b=0;b<l.faces.length-1;b++){var d=new Array();for(var a=0;a<l.faces[b].points.length;a++){if($defined(this.localTransformation[c])){var h=this.transform(l.faces[b].points[a],this.localTransformation[c])}else{var h=this.transform(l.faces[b].points[a])}d.push(new JS3D_Point(h.x,h.y,h.z))}var g=new JS3D_Face(d,l.faces[b].fillStyle);this.geometry.push(g)}if($defined(this.localTransformation[c])){this.labelAnchors[c]=this.transform(l.anchorPoint,this.localTransformation[c]);this.slices[c].origin=this.transform(l.origin,this.localTransformation[c])}this.labelAnchors[c]=this.transform(l.anchorPoint);this.slices[c].origin=this.transform(l.origin)}this.geometry_centers=new Array(this.geometry.length);for(var c=0;c<this.geometry.length;c++){this.geometry_centers[c]={l:this.geometry[c].lowestZ,h:this.geometry[c].highestZ,z:this.geometry[c].center.z,idx:c}}var e=this;this.geometry_centers=this.geometry_centers.sort((function(i,f){if(i.z<f.z){return 1}else{if(i.z>f.z){return -1}}var k=this.geometry[i.idx].distanceToRoot;var j=this.geometry[f.idx].distanceToRoot;if(k>j){return -1}else{return 1}return 0}).bind(e))},drawShadow:function(n,j,i,l,d,a,m,k,c,f){var e=f-c*0.05;for(var g=c;g>0;g--){n.roundRect(j-g+m,i-g+k,l+2*g,d+2*g,a+g,true,false,"rgba(0,0,0,"+e+")")}},drawLegend:function(c){var b=this.legend.width*this.canvasWidth;var e=this.slices.length*this.legend.font.size*this.legend.lineHeight+this.legend.font.size;var a,g;if(this.legend.position[0]="t"){g=this.legend.shadow.blur-this.legend.shadow.offset.y}else{if(this.legend.position[0]="b"){g=this.canvasHeight-e-this.legend.shadow.blur-this.legend.shadow.offset.y}}if(this.legend.position[1]="r"){a=this.canvasWidth-b-this.legend.shadow.blur-this.legend.shadow.offset.x}else{if(this.legend.position[1]="r"){a=this.legend.shadow.blur-this.legend.shadow.offset.x}}if(!($defined(a)&&$defined(g))){return}this.drawShadow(c,a,g,b,e,5,this.legend.shadow.offset.x,this.legend.shadow.offset.y,this.legend.shadow.blur,this.legend.shadow.opacity);c.roundRect(a,g,b,e,5,true,false,this.legend.fillStyle);c.font=this.legend.font.size+"px "+this.legend.font.family;c.fillStyle=this.legend.textColor;var f=g;for(var d=0;d<this.slices.length;d++){f+=Math.round(this.legend.font.size*this.legend.lineHeight);c.roundRect(a+4,f-this.legend.font.size/(0.75*this.legend.lineHeight),this.legend.font.size,this.legend.font.size,3,true,true,this.slices[d].fillStyle,"rgba(220,220,220,.8)",2);c.fillText(this.labels[d],a+1.5*this.legend.font.size,f)}},draw:function(){var b=this.canvas.getContext("2d");b.save();b.clearRect(0,0,this.canvas.width,this.canvas.height);var a=b;for(var d=0;d<this.geometry_centers.length;d++){var e=this.geometry[this.geometry_centers[d].idx];a.strokeStyle=e.fillStyle;a.fillStyle=e.fillStyle;var f=e.points[0];a.beginPath();a.moveTo(f.x,f.y);for(var c=1;c<e.points.length;c++){f=e.points[c];a.lineTo(f.x,f.y)}a.fill();if(this.showNormals){a.beginPath();a.moveTo(e.center.x,e.center.y);a.lineTo(e.center.x+e.normalVector0[0]*50,e.center.y+e.normalVector0[1]*50);a.strokeStyle="black";a.stroke();a.beginPath();a.arc(e.center.x+e.normalVector0[0]*50,e.center.y+e.normalVector0[1]*50,5,0,Math.PI*2,false);a.fillStyle="yellow";a.fill();a.stroke()}}this.drawLegend(b);b.restore()}});